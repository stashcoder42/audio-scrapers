name: "Reddit"
audioByURL:
  - action: scrapeJson
    url:
      - reddit.com
      - old.reddit.com
    queryURL: https://api.reddit.com/api/info?id=t3_{url}
    queryURLReplace:
      url:
        - regex: '.+/comments/([a-z0-9]+)/.+'
          with: "${1}"
    scraper: redditAudioScraper

jsonScrapers:
  redditAudioScraper:
    audio:
      Title:
        selector: data.children.0.data.title
        postProcess:
          - javascript: |
              // Remove all bracketed tags like [F4M] for cleaner display
              return value.replace(/\[[^\]]+\]\s*/g, '').trim();
      Details:
        selector: "data.children.0.data.{selftext,title}"
        postProcess:
          - javascript: |
              // gjson multipath returns JSON object with both fields
              var obj;
              try {
                obj = JSON.parse(value);
              } catch (e) {
                // Fallback: value might be just selftext
                obj = { selftext: value, title: '' };
              }
              var selftext = obj.selftext || '';
              var title = obj.title || '';

              // If post is deleted, use the full title as description
              if (selftext === '[deleted]' || selftext === '[removed]' || selftext.trim() === '') {
                return title;
              }

              // Decode HTML entities first (before extracting links)
              selftext = selftext.replace(/&amp;/g, '&');
              selftext = selftext.replace(/&lt;/g, '<');
              selftext = selftext.replace(/&gt;/g, '>');
              selftext = selftext.replace(/&quot;/g, '"');
              selftext = selftext.replace(/&#39;/g, "'");
              // Helper to strip utm_ parameters from URLs
              function stripUtm(url) {
                return url.replace(/[?&]utm_[^&]+/g, '').replace(/\?&/, '?').replace(/\?$/, '');
              }
              // Collect links and convert to reference-style [n] with footnotes
              var links = [];
              selftext = selftext.replace(/\[([^\]]+)\]\(([^)]+)\)/g, function(match, text, url) {
                links.push(stripUtm(url));
                return text + ' [' + links.length + ']';
              });
              // Remove bold markers
              selftext = selftext.replace(/\*\*([^*]+)\*\*/g, '$1');
              // Remove italic markers
              selftext = selftext.replace(/\*([^*]+)\*/g, '$1');
              // Remove heading markers
              selftext = selftext.replace(/^#{1,6}\s*/gm, '');
              // Clean up excessive newlines
              selftext = selftext.replace(/\n{3,}/g, '\n\n');
              // Add footnotes if there are links
              if (links.length > 0) {
                selftext = selftext.trim() + '\n\n---\n';
                for (var i = 0; i < links.length; i++) {
                  selftext += '[' + (i + 1) + '] ' + links[i] + '\n';
                }
              }
              return selftext.trim();
      Date:
        selector: data.children.0.data.created_utc
        postProcess:
          - parseDate: unix
      Performers:
        Name:
          selector: data.children.0.data.author
          postProcess:
            - javascript: |
                // Don't return [deleted] as performer name
                if (value === '[deleted]' || value === '[removed]') {
                  return '';
                }
                return value;
        URLs:
          selector: data.children.0.data.author
          postProcess:
            - javascript: |
                // Don't return URL for deleted users
                if (value === '[deleted]' || value === '[removed]') {
                  return '';
                }
                return 'https://www.reddit.com/user/' + value;
      Tags:
        Name:
          selector: data.children.0.data.title
          postProcess:
            - javascript: |
                var matches = value.match(/\[([^\]]+)\]/g);
                if (matches) {
                  return matches.map(function(m) { return m.slice(1, -1); }).join('\n');
                }
                return '';
          split: "\n"
      URLs:
        selector: data.children.0.data.selftext
        postProcess:
          - javascript: |
              // Extract soundgasm and whyp links from selftext
              var urls = [];
              var soundgasm = value.match(/https?:\/\/soundgasm\.net\/u\/[^\s\)\]]+/g);
              var whyp = value.match(/https?:\/\/whyp\.it\/tracks\/[^\s\)\]]+/g);
              if (soundgasm) urls = urls.concat(soundgasm);
              if (whyp) urls = urls.concat(whyp);
              return urls.join('\n');
        split: "\n"

driver:
  headers:
    - Key: User-Agent
      Value: stashapp/audio-scrapers:v1 (by /u/stashcoder42)
